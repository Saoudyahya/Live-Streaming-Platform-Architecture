<!DOCTYPE html>
<html>
<head>
    <title>SRS Stream Player - Debug Version</title>
    <script src="https://vjs.zencdn.net/8.0.4/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.0.4/video-js.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info {
            margin-bottom: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .online { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .offline { background: #ffebee; border-left: 4px solid #f44336; }
        .debug {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .buttons {
            margin-top: 20px;
        }
        .buttons button {
            margin-right: 10px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            background: #2196f3;
            color: white;
            cursor: pointer;
        }
        .buttons button:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SRS Streaming Server - Debug Version</h1>
        
        <div class="info">
            <strong>RTMP URL:</strong> rtmp://localhost:1935/live<br>
            <strong>Stream Key:</strong> test<br>
            <strong>HLS URL:</strong> http://localhost:8080/hls/live/test.m3u8<br>
            <strong>SRS API:</strong> http://localhost:1985/api/v1/streams/
        </div>

        <video-js id="player" class="vjs-default-skin" controls preload="auto" width="800" height="450" data-setup="{}">
            <source src="http://localhost:8080/hls/live/test.m3u8" type="application/x-mpegURL">
            <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a web browser that
                <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
            </p>
        </video-js>
        
        <div id="status" class="status offline">
            <strong>Status:</strong> <span id="statusText">Checking stream...</span>
        </div>

        <div class="buttons">
            <button onclick="checkStream()">Check Stream</button>
            <button onclick="checkSRS()">Check SRS API</button>
            <button onclick="player.load()">Reload Player</button>
            <button onclick="testDirectAccess()">Test Direct Access</button>
            <button onclick="clearDebug()">Clear Debug</button>
        </div>
        
        <div id="debug" class="debug">
            <strong>Debug Log:</strong><br>
        </div>
    </div>
    
    <script>
        var player = videojs('player', {
            autoplay: false,
            muted: true,
            liveui: true,
            html5: {
                hls: {
                    enableLowInitialPlaylist: true,
                    smoothQualityChange: true,
                    overrideNative: true
                }
            }
        });

        function addDebugLog(message) {
            const debugEl = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debugEl.innerHTML += `[${time}] ${message}<br>`;
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(message);
        }

        function clearDebug() {
            document.getElementById('debug').innerHTML = '<strong>Debug Log:</strong><br>';
        }

        // Check if HLS stream is available
        async function checkStream() {
            addDebugLog('Checking HLS stream availability...');
            try {
                const response = await fetch('http://localhost:8080/hls/live/test.m3u8');
                const statusEl = document.getElementById('status');
                const statusText = document.getElementById('statusText');
                
                addDebugLog(`HLS Response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const content = await response.text();
                    addDebugLog(`HLS Content length: ${content.length} characters`);
                    addDebugLog(`HLS Content preview: ${content.substring(0, 200)}...`);
                    
                    statusEl.className = 'status online';
                    statusText.textContent = 'HLS Stream is available';
                    player.src('http://localhost:8080/hls/live/test.m3u8');
                } else {
                    addDebugLog(`HLS Error: ${response.status} - ${response.statusText}`);
                    statusEl.className = 'status offline';
                    statusText.textContent = 'HLS Stream is not available';
                }
            } catch (error) {
                addDebugLog(`HLS Fetch Error: ${error.message}`);
                const statusEl = document.getElementById('status');
                const statusText = document.getElementById('statusText');
                statusEl.className = 'status offline';
                statusText.textContent = 'Cannot connect to HLS endpoint';
            }
        }

        // Check SRS API for active streams
        async function checkSRS() {
            addDebugLog('Checking SRS API for active streams...');
            try {
                const response = await fetch('http://localhost:1985/api/v1/streams/');
                addDebugLog(`SRS API Response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addDebugLog(`SRS API Data: ${JSON.stringify(data, null, 2)}`);
                    
                    if (data.streams && data.streams.length > 0) {
                        addDebugLog(`Found ${data.streams.length} active stream(s)`);
                        data.streams.forEach((stream, index) => {
                            addDebugLog(`Stream ${index + 1}: ${stream.name} - ${stream.url}`);
                        });
                    } else {
                        addDebugLog('No active streams found in SRS');
                    }
                } else {
                    addDebugLog(`SRS API Error: ${response.status} - ${response.statusText}`);
                }
            } catch (error) {
                addDebugLog(`SRS API Fetch Error: ${error.message}`);
            }
        }

        // Test direct access to HLS directory
        async function testDirectAccess() {
            addDebugLog('Testing direct access to HLS directory...');
            try {
                const response = await fetch('http://localhost:8080/hls/');
                addDebugLog(`HLS Directory Response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const content = await response.text();
                    addDebugLog(`Directory listing available: ${content.length > 0 ? 'Yes' : 'No'}`);
                } else {
                    addDebugLog(`HLS Directory Error: ${response.status} - ${response.statusText}`);
                }
            } catch (error) {
                addDebugLog(`HLS Directory Error: ${error.message}`);
            }
        }

        // Check stream status on load
        addDebugLog('Page loaded, initializing...');
        checkStream();
        
        // Auto-refresh stream status every 10 seconds
        setInterval(checkStream, 10000);

        // Player event handlers
        player.on('loadstart', function() {
            addDebugLog('Player: Loading stream...');
        });

        player.on('canplay', function() {
            addDebugLog('Player: Stream ready to play');
        });

        player.on('error', function() {
            const error = player.error();
            addDebugLog(`Player Error: ${error ? error.message : 'Unknown error'}`);
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusEl.className = 'status offline';
            statusText.textContent = 'Player error - check debug log';
        });

        player.on('play', function() {
            addDebugLog('Player: Started playing');
        });

        player.on('pause', function() {
            addDebugLog('Player: Paused');
        });
    </script>
</body>
</html>