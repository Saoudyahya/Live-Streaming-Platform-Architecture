<!DOCTYPE html>
<html>
<head>
    <title>Ultra Low Latency Live Stream</title>
    <script src="https://vjs.zencdn.net/8.0.4/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.0.4/video-js.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #000;
        }
        h1 {
            font-size: 16px;
            margin: 10px 0;
            color: #fff;
        }
        .player-container {
            position: relative;
            max-width: 800px;
        }
        .latency-info {
            color: #fff;
            margin: 10px 0;
            font-size: 12px;
        }
        #refresh-btn {
            background: #ff0000;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 10px 5px 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        #refresh-btn:hover {
            background: #cc0000;
        }
    </style>
</head>
<body>
    <h1>Ultra Low Latency Live Stream</h1>
    <div class="latency-info">
        <span id="latency-display">Latency: Calculating...</span>
        <button id="refresh-btn" onclick="refreshStream()">Force Refresh</button>
    </div>

    <div class="player-container">
        <video-js id="player" class="vjs-default-skin"
                  controls preload="none"
                  width="800" height="450"
                  data-setup='{}'>
            <source src="http://localhost:8080/hls/test.m3u8" type="application/x-mpegURL">
        </video-js>
    </div>

    <script>
        // Ultra low latency configuration
        var player = videojs('player', {
            autoplay: true,
            muted: true,
            liveui: true,
            fluid: true,
            preload: 'none',

            // Aggressive low latency HLS settings
            html5: {
                hls: {
                    enableLowInitialPlaylist: true,
                    smoothQualityChange: false,
                    overrideNative: true,

                    // Ultra aggressive buffering settings
                    maxPlaylistRetries: 1,
                    playlistExclusionDuration: 1,

                    // Minimal buffering
                    experimentalBufferBasedABR: false,
                    experimentalLLHLS: true,

                    // Fast seeking
                    fastQualityChange: true,
                }
            },

            // Minimal playback rates
            playbackRates: [1],

            // Live streaming optimizations
            liveTracker: {
                trackingThreshold: 0,
                liveTolerance: 0.5
            }
        });

        var startTime = Date.now();
        var latencyElement = document.getElementById('latency-display');

        player.ready(function() {
            console.log('Player ready');

            // Force live edge seeking aggressively
            player.liveTracker.on('liveedgechange', function() {
                if (!player.liveTracker.atLiveEdge()) {
                    player.liveTracker.seekToLiveEdge();
                }
            });

            // Minimize buffering
            player.on('loadstart', function() {
                startTime = Date.now();
            });

            player.on('canplay', function() {
                var latency = Date.now() - startTime;
                latencyElement.textContent = `Estimated Latency: ${latency}ms`;

                // Auto-seek to live edge
                if (player.liveTracker && player.liveTracker.seekToLiveEdge) {
                    player.liveTracker.seekToLiveEdge();
                }
            });

            // Monitor buffering and force live edge
            player.on('timeupdate', function() {
                if (player.liveTracker && !player.liveTracker.atLiveEdge()) {
                    var currentTime = player.currentTime();
                    var duration = player.duration();
                    var timeFromLive = duration - currentTime;

                    // If more than 2 seconds behind live, jump forward
                    if (timeFromLive > 2) {
                        player.liveTracker.seekToLiveEdge();
                    }
                }
            });

            // Handle errors by refreshing
            player.on('error', function() {
                console.log('Player error, attempting refresh...');
                setTimeout(refreshStream, 1000);
            });
        });

        // Force refresh function
        function refreshStream() {
            var currentSrc = player.src();
            var timestamp = new Date().getTime();
            var newSrc = currentSrc.split('?')[0] + '?t=' + timestamp;

            player.src(newSrc);
            player.load();
            player.play();

            startTime = Date.now();
            latencyElement.textContent = 'Latency: Refreshing...';
        }

        // Auto-refresh every 30 seconds to maintain low latency
        setInterval(function() {
            if (player.liveTracker && !player.liveTracker.atLiveEdge()) {
                refreshStream();
            }
        }, 30000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' || e.key === 'R') {
                refreshStream();
            }
            if (e.key === 'l' || e.key === 'L') {
                if (player.liveTracker) {
                    player.liveTracker.seekToLiveEdge();
                }
            }
        });
    </script>
</body>
</html>